name: Build and Deploy Staging
on: 
  push:
    branches:
      - staging
    paths: [".github/workflows/build-publish-staging.yml", "packages/hexhive-styles/src/**", "packages/hexhive-ui/src/components/**", "packages/hexhive-ui/src/views/**", "packages/hexhive-ui/src/modals/**", "packages/hexhive-ui/src/hooks/**"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v2.3.1
       
      - name: "Use NodeJS 16"
        uses: actions/setup-node@v2
        with:
          node-version: '16.13.0'
          registry-url: 'https://registry.npmjs.org'

      # - name: Setup NPM Token
      #   run: npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: |
          npm install
          npx lerna bootstrap --no-ci

      - name: Build # Build all packages
        run: npx lerna run build

      - name: "Version and publish" # Interesting step
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor}}@users.noreply.github.com"

          if [ ${{ github.ref }} = refs/heads/staging ]; then
            npx lerna version --conventional-commits --conventional-prerelease --preid alpha --yes 
          else
            npx lerna version --conventional-commits --conventional-graduate --yes
          fi

          npx lerna publish from-git --no-verify-access --yes 
